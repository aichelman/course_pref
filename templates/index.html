<!DOCTYPE html>
<html>
<head>
    <title>Fairway Pairwise</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
</head>
<body>
    <!-- Background Slideshow -->
    <div class="background-slideshow">
        <div class="slide slide1 active" data-bg="/static/images/golf3.jpeg"></div>
        <div class="slide slide2" data-bg="/static/images/golf4.jpeg"></div>
    </div>

    <!-- Photo Credit -->
    <div class="photo-credit">
        Photos by Cam Lange
    </div>

    <div class="container py-4">
        <nav class="navbar navbar-custom mb-4">
            <div class="container-fluid">
                <span class="navbar-brand">Welcome, {{ username }}!</span>
                <a href="/logout" class="btn btn-logout">Logout</a>
            </div>
        </nav>

        <h1 class="page-title text-center">Fairway Pairwise</h1>

    <div class="row mt-5">

        <!-- Pairwise Voting Section -->
        <div class="col-lg-6 mb-4">
            <div class="card-modern">
                <div class="card-header-custom">
                    Choose Your Favorite
                </div>
                <div id="courses" class="d-flex gap-3 mb-4">
                    <button id="course1" class="btn course-btn course-btn-1 w-50"></button>
                    <button id="course2" class="btn course-btn course-btn-2 w-50"></button>
                </div>

                <!-- Ranking List Section -->
                <h4 class="mt-5 mb-3" style="color: var(--golf-green); font-weight: 700;">
                    Your Rankings
                </h4>
                <ul id="rankings" class="list-group rankings-list"></ul>
            </div>
        </div>

        <!-- Search & Add Course Section -->
        <div class="col-lg-6 mb-4">
            <!-- CSV Upload -->
            <div class="card-modern mb-4">
                <div class="card-header-custom">
                    Upload CSV File
                </div>
                <div class="file-upload-wrapper">
                    <input type="file" id="csvFile" class="form-control file-upload-input mb-3" accept=".csv">
                </div>
                <button class="btn btn-golf-primary w-100" onclick="uploadCSV()">Upload Courses</button>
                <small class="text-muted d-block mt-3 text-center">
                    <strong>CSV format:</strong> One course name per line
                </small>
            </div>

            <!-- Search Courses -->
            <div class="card-modern mb-4">
                <div class="card-header-custom">
                    Search & Add Course
                </div>
                <div class="input-group mb-3">
                    <div style="position: relative; flex: 1;">
                        <input type="text" id="searchQuery" class="form-control form-control-modern" placeholder="Search for golf courses..." onkeypress="if(event.key === 'Enter') searchCourses()" style="padding-right: 40px;">
                        <button onclick="clearSearch()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: none; color: #6c757d; font-size: 1.2rem; cursor: pointer; padding: 0 5px;" title="Clear search">âœ•</button>
                    </div>
                    <button class="btn btn-golf-secondary" onclick="searchCourses()" style="border-radius: 12px; margin-left: 10px;">Search</button>
                </div>
                <div id="searchResults"></div>
            </div>

            <!-- GHIN Integration (Collapsible) -->
            <div class="text-center mb-4">
                <button class="btn btn-outline-secondary btn-sm" onclick="toggleGHIN()" id="ghinToggleBtn">
                    Connect to GHIN to pull latest rounds
                </button>
            </div>

            <div id="ghinSection" style="display: none;">
                <div class="card-modern">
                    <div class="card-header-custom">
                        Connect to GHIN
                    </div>
                    <p class="text-muted mb-3">Import courses from your GHIN score history</p>
                    <div class="mb-3">
                        <label for="ghinUsername" class="form-label-modern">GHIN Username or Email</label>
                        <input type="text" id="ghinUsername" class="form-control form-control-modern" placeholder="Enter your GHIN username or email">
                    </div>
                    <div class="mb-3">
                        <label for="ghinPassword" class="form-label-modern">GHIN Password</label>
                        <input type="password" id="ghinPassword" class="form-control form-control-modern" placeholder="Enter your GHIN password">
                    </div>
                    <div class="mb-3">
                        <label for="monthsBack" class="form-label-modern">Import from past</label>
                        <select id="monthsBack" class="form-control form-control-modern">
                            <option value="12">12 months (1 year)</option>
                            <option value="24">24 months (2 years)</option>
                            <option value="36">36 months (3 years)</option>
                            <option value="60">60 months (5 years)</option>
                            <option value="120">120 months (10 years)</option>
                        </select>
                    </div>
                    <button class="btn btn-golf-primary w-100 mb-3" onclick="connectGHIN()">Import from GHIN</button>
                    <button class="btn btn-outline-secondary w-100 mb-3" onclick="toggleGHIN()">Cancel</button>
                    <div id="ghinStatus" class="mt-3"></div>
                    <small class="text-muted d-block mt-3">
                        <strong>Note:</strong> Your GHIN credentials are only used once to fetch courses and are not stored.
                    </small>
                </div>
            </div>
        </div>

    </div>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            loadPair();
            loadRankings();
            startSlideshow();
        });

        // Background slideshow with lazy loading
        function startSlideshow() {
            const slides = document.querySelectorAll('.slide');
            let currentSlide = 0;

            // Load first image immediately
            loadSlideImage(slides[0]);

            // Preload next image
            if (slides[1]) loadSlideImage(slides[1]);

            setInterval(() => {
                slides[currentSlide].classList.remove('active');
                currentSlide = (currentSlide + 1) % slides.length;

                // Load current image if not loaded
                loadSlideImage(slides[currentSlide]);

                // Preload next image
                const nextSlide = (currentSlide + 1) % slides.length;
                loadSlideImage(slides[nextSlide]);

                slides[currentSlide].classList.add('active');
            }, 60000); // Change image every 1 minute
        }

        function loadSlideImage(slide) {
            if (!slide.classList.contains('loaded')) {
                const bgUrl = slide.getAttribute('data-bg');
                if (bgUrl) {
                    slide.style.backgroundImage = `url('${bgUrl}')`;
                    slide.classList.add('loaded');
                }
            }
        }

        function loadPair() {
            fetch('/pair')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('course1').textContent = 'Add courses to start ranking';
                        document.getElementById('course2').textContent = 'Use search or CSV upload';
                        document.getElementById('course1').onclick = null;
                        document.getElementById('course2').onclick = null;
                        return;
                    }
                    document.getElementById('course1').textContent = data.course1;
                    document.getElementById('course2').textContent = data.course2;

                    document.getElementById('course1').onclick = () => vote(data.course1, data.course2);
                    document.getElementById('course2').onclick = () => vote(data.course2, data.course1);
                });
        }

        function vote(winner, loser) {
            fetch('/vote', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({winner, loser})
            }).then(() => {
                loadPair();
                loadRankings();
            });
        }

        function loadRankings() {
            fetch('/rankings')
                .then(response => response.json())
                .then(data => {
                    const rankings = document.getElementById('rankings');
                    rankings.innerHTML = '';
                    if (data.length === 0) {
                        rankings.innerHTML = '<li class="list-group-item text-center text-muted">No courses yet. Add some courses to start ranking!</li>';
                        return;
                    }
                    data.forEach((course, index) => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item ranking-item';
                        li.innerHTML = `
                            <span class="ranking-number">${index + 1}</span>
                            <strong>${course.name}</strong>
                            <span class="ranking-rating">${course.rating}</span>
                        `;
                        rankings.appendChild(li);
                    });
                });
        }

function searchCourses() {
    const query = document.getElementById('searchQuery').value;
    if (!query.trim()) return;

    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = '<div class="text-center text-muted">Searching...</div>';

    fetch(`/search_courses?query=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(results => {
            resultsDiv.innerHTML = '';
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="text-center text-muted">No courses found. Try a different search.</div>';
                return;
            }
            results.forEach(course => {
                const div = document.createElement('div');
                div.className = 'search-result-item d-flex justify-content-between align-items-center';
                div.innerHTML = `
                    <div>
                        <strong style="color: var(--golf-green);">${course.name}</strong><br>
                        <small class="text-muted">${course.address}</small>
                    </div>
                    <button class="btn btn-golf-primary btn-sm" onclick='addCourse("${course.name.replace(/'/g, "\\'")}","${course.address.replace(/'/g, "\\'")}")'>Add</button>
                `;
                resultsDiv.appendChild(div);
            });
        })
        .catch(error => {
            resultsDiv.innerHTML = '<div class="text-center text-danger">Error searching. Please try again.</div>';
        });
}

function addCourse(name, address) {
    fetch('/add_course', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name, address})
    }).then(res => res.json())
      .then(data => {
          if (data.status === 'added') {
              alert(`${name} added!`);
              loadRankings();
              loadPair();
              clearSearch(); // Clear search after adding course
          } else {
              alert(`${name} already exists in your list!`);
          }
      });
}

function clearSearch() {
    document.getElementById('searchQuery').value = '';
    document.getElementById('searchResults').innerHTML = '';
}

function toggleGHIN() {
    const section = document.getElementById('ghinSection');
    const button = document.getElementById('ghinToggleBtn');

    if (section.style.display === 'none') {
        section.style.display = 'block';
        button.style.display = 'none';
    } else {
        section.style.display = 'none';
        button.style.display = 'inline-block';
        // Clear form when hiding
        document.getElementById('ghinUsername').value = '';
        document.getElementById('ghinPassword').value = '';
        document.getElementById('ghinStatus').innerHTML = '';
    }
}

async function connectGHIN() {
    const username = document.getElementById('ghinUsername').value;
    const password = document.getElementById('ghinPassword').value;
    const monthsBack = parseInt(document.getElementById('monthsBack').value);
    const statusDiv = document.getElementById('ghinStatus');

    if (!username || !password) {
        statusDiv.innerHTML = '<div class="alert alert-danger-modern alert-modern">Please enter your GHIN username and password</div>';
        return;
    }

    statusDiv.innerHTML = '<div class="text-center text-muted">Connecting to GHIN and fetching courses...</div>';

    try {
        // Step 1: Get Firebase session token
        const firebaseResponse = await fetch('https://firebaseinstallations.googleapis.com/v1/projects/ghin-mobile-app/installations', {
            method: 'POST',
            headers: {
                'x-goog-api-key': 'AIzaSyBxgTOAWxiud0HuaE5tN-5NTlzFnrtyz-I',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                appId: '1:884417644529:web:47fb315bc6c70242f72650',
                authVersion: 'FIS_v2',
                fid: 'fg6JfS0U01YmrelthLX9Iz',
                sdkVersion: 'w:0.5.7'
            })
        });

        if (!firebaseResponse.ok) {
            throw new Error('Failed to get Firebase session token');
        }

        const firebaseData = await firebaseResponse.json();
        const sessionToken = firebaseData.authToken.token;

        // Step 2: Login to GHIN with session token
        const loginResponse = await fetch('https://api2.ghin.com/api/v1/golfer_login.json', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json; charset=utf-8',
                'Accept': 'application/json',
                'User-Agent': 'Mozilla/5.0'
            },
            body: JSON.stringify({
                user: {
                    email_or_ghin: username,
                    password: password,
                    remember_me: 'true'
                },
                token: sessionToken
            })
        });

        if (!loginResponse.ok) {
            throw new Error('Invalid GHIN credentials');
        }

        const loginData = await loginResponse.json();
        const accessToken = loginData.golfer_user.golfer_user_token;
        const golferId = loginData.golfer_user.golfer_id || username;

        // Step 3: Fetch scores
        const scoresResponse = await fetch(`https://api2.ghin.com/api/v1/golfers/${golferId}/scores.json`, {
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Accept': 'application/json'
            }
        });

        if (!scoresResponse.ok) {
            throw new Error('Failed to fetch score history');
        }

        const scoresData = await scoresResponse.json();

        // Step 4: Extract unique course names from date range
        const cutoffDate = new Date();
        cutoffDate.setMonth(cutoffDate.getMonth() - monthsBack);

        const coursesFound = new Set();
        scoresData.scores.forEach(score => {
            if (score.played_at) {
                const scoreDate = new Date(score.played_at);
                if (scoreDate >= cutoffDate) {
                    const courseName = score.course_name || score.club_name;
                    if (courseName) {
                        coursesFound.add(courseName);
                    }
                }
            }
        });

        // Step 5: Send course names to backend to add them
        const addResponse = await fetch('/add_courses_bulk', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                courses: Array.from(coursesFound)
            })
        });

        const addData = await addResponse.json();

        if (addData.status === 'success') {
            statusDiv.innerHTML = `<div class="alert alert-success-modern alert-modern">
                <strong>Success!</strong><br>
                Found ${addData.total_found} courses in your history<br>
                Added ${addData.added} new courses<br>
                ${addData.already_exists} courses already in your list
            </div>`;
            // Clear the form
            document.getElementById('ghinUsername').value = '';
            document.getElementById('ghinPassword').value = '';
            // Refresh rankings and pair
            loadRankings();
            loadPair();
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger-modern alert-modern">${addData.message}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-danger-modern alert-modern">Error: ${error.message}</div>`;
    }
}

function uploadCSV() {
    const fileInput = document.getElementById('csvFile');
    const file = fileInput.files[0];

    if (!file) {
        alert('Please select a CSV file first');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);

    fetch('/upload_csv', {
        method: 'POST',
        body: formData
    }).then(res => res.json())
      .then(data => {
          if (data.status === 'success') {
              alert(`Successfully added ${data.added} courses!`);
              loadRankings();
              loadPair();
              fileInput.value = '';
          } else {
              alert(`Error: ${data.message}`);
          }
      })
      .catch(error => {
          alert('Error uploading file. Please try again.');
      });
}
</script>

</body>
</html>
