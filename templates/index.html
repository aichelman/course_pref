<!DOCTYPE html>
<html>
<head>
    <title>Golf Course Rankings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-5">

    <nav class="navbar navbar-light bg-light mb-4 rounded">
        <div class="container-fluid">
            <span class="navbar-brand">Welcome, {{ username }}!</span>
            <a href="/logout" class="btn btn-outline-danger">Logout</a>
        </div>
    </nav>

    <h1 class="text-center">Golf Course Ranking</h1>

    <div class="row mt-5">

        <!-- Pairwise Voting Section -->
        <div class="col-md-6">
            <h3 class="mb-4">Choose Your Favorite</h3>
            <div id="courses" class="d-flex justify-content-around mb-3">
                <button id="course1" class="btn btn-primary w-50 mx-1"></button>
                <button id="course2" class="btn btn-success w-50 mx-1"></button>
            </div>

            <!-- Ranking List Section -->
            <h4 class="mt-4">Current Rankings:</h4>
            <ul id="rankings" class="list-group"></ul>
        </div>

        <!-- Search & Add Course Section -->
        <div class="col-md-6">
            <h3>Add Golf Courses</h3>

            <!-- CSV Upload -->
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Upload CSV File</h5>
                    <input type="file" id="csvFile" class="form-control mb-2" accept=".csv">
                    <button class="btn btn-primary w-100" onclick="uploadCSV()">Upload CSV</button>
                    <small class="text-muted d-block mt-2">CSV format: One course name per line</small>
                </div>
            </div>

            <!-- Search Courses -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Search & Add Course</h5>
                    <div class="input-group mb-3">
                        <input type="text" id="searchQuery" class="form-control" placeholder="Search Golf Courses">
                        <button class="btn btn-outline-secondary" onclick="searchCourses()">Search</button>
                    </div>
                    <ul class="list-group" id="searchResults"></ul>
                </div>
            </div>
        </div>

    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            loadPair();
            loadRankings();
        });

        function loadPair() {
            fetch('/pair')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('course1').textContent = 'Add courses to start ranking';
                        document.getElementById('course2').textContent = 'Use search or CSV upload';
                        document.getElementById('course1').onclick = null;
                        document.getElementById('course2').onclick = null;
                        return;
                    }
                    document.getElementById('course1').textContent = data.course1;
                    document.getElementById('course2').textContent = data.course2;

                    document.getElementById('course1').onclick = () => vote(data.course1, data.course2);
                    document.getElementById('course2').onclick = () => vote(data.course2, data.course1);
                });
        }

        function vote(winner, loser) {
            fetch('/vote', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({winner, loser})
            }).then(() => {
                loadPair();
                loadRankings();
            });
        }

        function loadRankings() {
            fetch('/rankings')
                .then(response => response.json())
                .then(data => {
                    const rankings = document.getElementById('rankings');
                    rankings.innerHTML = '';
                    data.forEach((course, index) => {
                        rankings.innerHTML += `<li class="list-group-item">
                            ${index + 1}. ${course.name} (${course.rating})
                        </li>`;
                    });
                });
        }

function searchCourses() {
    const query = document.getElementById('searchQuery').value;
    fetch(`/search_courses?query=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(results => {
            const ul = document.getElementById('searchResults');
            ul.innerHTML = '';
            results.forEach(course => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `<strong>${course.name}</strong><br><small>${course.address}</small>`;
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-success';
                btn.innerText = 'Add';
                btn.onclick = () => addCourse(course.name, course.address);
                li.appendChild(btn);
                ul.appendChild(li);
            });
        });
}

function addCourse(name, address) {
    fetch('/add_course', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name, address})
    }).then(res => res.json())
      .then(data => {
          if (data.status === 'added') {
              alert(`${name} added!`);
              loadRankings();
              loadPair();
          } else {
              alert(`${name} already exists in your list!`);
          }
      });
}

function uploadCSV() {
    const fileInput = document.getElementById('csvFile');
    const file = fileInput.files[0];

    if (!file) {
        alert('Please select a CSV file first');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);

    fetch('/upload_csv', {
        method: 'POST',
        body: formData
    }).then(res => res.json())
      .then(data => {
          if (data.status === 'success') {
              alert(`Successfully added ${data.added} courses!`);
              loadRankings();
              loadPair();
              fileInput.value = '';
          } else {
              alert(`Error: ${data.message}`);
          }
      })
      .catch(error => {
          alert('Error uploading file. Please try again.');
      });
}
</script>

</body>
</html>
